name: Freshness (deterministic hygiene + image/SME flags)

on:
  workflow_dispatch:
  push:
    paths:
      - 'data/engagement-latest.xlsx'

permissions:
  contents: write
  pull-requests: write

env:
  TARGET_BRANCH: main
  WORKING_BRANCH_PREFIX: chore/freshness
  DOCSET_ROOT: powerbi-docs
  REPORT_XLSX: data/engagement-latest.xlsx
  STALE_FILE_LIST: tools/stale-files.txt
  BATCH_LIMIT: "25"
  FRESH_WINDOW_DAYS: "365"
  PR_LABELS: "freshness,automation,doc-hygiene"

jobs:
  freshness:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chunk: [0, 1, 2, 3, 4] # 5 PRs per run
    steps:
      # Checkout optimized for speed
      - name: Checkout (sparse, shallow, blobless)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            powerbi-docs
            tools
            data
          sparse-checkout-cone-mode: true
          filter: blob:none
          submodules: false
          lfs: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl python-dateutil pyyaml

      # Generate stale batch with offset for chunk
      - name: Generate stale batch
        run: |
          python tools/generate-stale-list.py \
            --input "${{ env.REPORT_XLSX }}" \
            --output "${{ env.STALE_FILE_LIST }}" \
            --docroot "${{ env.DOCSET_ROOT }}" \
            --limit "${{ env.BATCH_LIMIT }}" \
            --fresh-window-days "${{ env.FRESH_WINDOW_DAYS }}" \
            --offset $(( ${{ matrix.chunk }} * ${{ env.BATCH_LIMIT }} ))

      - name: Show batch
        run: |
          echo "Chunk: ${{ matrix.chunk }}"
          echo "Files to process:"
          cat "${{ env.STALE_FILE_LIST }}" || true
          echo ""
          echo "Summary:"
          head -n 10 "${{ env.STALE_FILE_LIST }}.summary.csv" || true
          echo ""
          echo "Skipped:"
          head -n 10 "${{ env.STALE_FILE_LIST }}.skipped.csv" || true

      # Hygiene: ms.date refresh
      - name: Update ms.date
        run: |
          TODAY=$(date +%Y-%m-%d)
          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            [ -f "$FILE" ] || continue
            if grep -q '^ms\.date:' "$FILE"; then
              sed -i "s/^ms\.date:.*/ms.date: $TODAY/" "$FILE"
            else
              awk -v today="$TODAY" '
                BEGIN{infront=0}
                NR==1 && /^---\s*$/ {print; print "ms.date: "today; infront=1; next}
                {print}
              ' "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"
            fi
          done < "${{ env.STALE_FILE_LIST }}"

      # Install deterministic tools
      - name: Install lint/format tools
        run: |
          npm install -g markdownlint-cli@0.40.0 prettier@3.3.3

      # Run markdownlint
      - name: Markdownlint
        run: |
          xargs -a "${{ env.STALE_FILE_LIST }}" -r -d '\n' markdownlint || true

      - name: Prettier format
        run: |
          if [ ! -s "${{ env.STALE_FILE_LIST }}" ]; then
            echo "No files to format; skipping Prettier."
            exit 0
          fi
          FILES=$(grep -E '\.md$' "${{ env.STALE_FILE_LIST }}" | xargs -r ls 2>/dev/null || true)
          if [ -z "$FILES" ]; then
            echo "No matching Markdown files found; skipping Prettier."
            exit 0
          fi
          echo "$FILES" | xargs prettier --write

      # Flag outdated images
      - name: Check for outdated images
        run: |
          OUTFILE="tools/outdated-images-${{ matrix.chunk }}.csv"
          echo "File,ImagePath,Reason" > "$OUTFILE"
          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            [ -f "$FILE" ] || continue
            grep -Eo '!\[[^]]*\]\([^)]*\)' "$FILE" | while read -r IMG; do
              ALT=$(echo "$IMG" | sed -E 's/^!\[([^]]*)\].*/\1/')
              SRC=$(echo "$IMG" | sed -E 's/.*\(([^)]*)\).*/\1/')
              if echo "$ALT" | grep -qiE 'classic|old ribbon|legacy'; then
                echo "$FILE,$SRC,Alt text suggests outdated UI" >> "$OUTFILE"
              fi
              if echo "$SRC" | grep -qiE 'classic|old|legacy'; then
                echo "$FILE,$SRC,Image filename suggests outdated UI" >> "$OUTFILE"
              fi
            done
          done < "${{ env.STALE_FILE_LIST }}"
          echo "Outdated image check complete. See $OUTFILE"

      # SME detection
      - name: SME detection
        continue-on-error: true
        run: |
          OUTFILE="tools/sme-flags-${{ matrix.chunk }}.csv"
          echo "File,Reason" > "$OUTFILE"
          if [ ! -s "${{ env.STALE_FILE_LIST }}" ]; then
            echo "No stale file list found or empty; skipping SME detection."
            exit 0
          fi
          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            [ -f "$FILE" ] || continue
            if grep -qiE 'public preview|private preview|deprecated|retired|feature flag|breaking change' "$FILE"; then
              echo "$FILE,Contains preview/deprecation/feature-flag language" >> "$OUTFILE"
            fi
          done < "${{ env.STALE_FILE_LIST }}"
          echo "SME flagging complete. See $OUTFILE"

      # Commit and push unique branch per chunk
      - name: Commit and push
        run: |
          git config user.name "docs-automation"
          git config user.email "docs-automation@users.noreply.github.com"
          BRANCH="${WORKING_BRANCH_PREFIX}/$(date -u +'%Y%m%d')-chunk${{ matrix.chunk }}"
          git checkout -b "$BRANCH" "origin/${TARGET_BRANCH}"
          git add -A
          git commit -m "Freshness: chunk ${{ matrix.chunk }} (deterministic hygiene)"
          git push --set-upstream origin "$BRANCH"

      # Open PR
      - name: Open PR
        uses: dotnet/actions-create-pull-request@v4
        with:
          token: ${{ github.token }}
          title: "Freshness: chunk ${{ matrix.chunk }} (25 docs)"
          body: |
            **Chunk:** ${{ matrix.chunk }}
            - Updated ms.date for stale docs
            - Ran markdownlint + Prettier
            - Flagged outdated images → tools/outdated-images-${{ matrix.chunk }}.csv
            - Flagged SME-needed cases → tools/sme-flags-${{ matrix.chunk }}.csv
          reviewers: "" # optional
          team-reviewers: "" # optional

