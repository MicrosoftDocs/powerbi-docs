name: Freshness (manual export + runtime ms.date check)
# This workflow processes an engagement export/report XLSX file to identify stale docs,
on:
  workflow_dispatch:
  push:
    paths:
      - 'data/engagement-latest.xlsx'

permissions:
  contents: write
  pull-requests: write

env:
  TARGET_BRANCH: main
  WORKING_BRANCH_PREFIX: chore/freshness
  DOCSET_ROOT: powerbi-docs
  REPORT_XLSX: data/engagement-latest.xlsx
  STALE_FILE_LIST: tools/stale-files.txt
  BATCH_LIMIT: "50"
  FRESH_WINDOW_DAYS: "365"
  PR_LABELS: "freshness,automation,doc-hygiene"

jobs:
  freshness:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl python-dateutil pyyaml

      - name: Generate stale batch from XLSX + runtime ms.date check
        run: |
          python tools/generate-stale-list.py \
            --input "${{ env.REPORT_XLSX }}" \
            --output "${{ env.STALE_FILE_LIST }}" \
            --docroot "${{ env.DOCSET_ROOT }}" \
            --limit "${{ env.BATCH_LIMIT }}" \
            --fresh-window-days "${{ env.FRESH_WINDOW_DAYS }}"

      - name: Show batch
        run: |
          echo "Files to process:"
          cat "${{ env.STALE_FILE_LIST }}" || true
          echo ""
          echo "Summary:"
          head -n 10 "${{ env.STALE_FILE_LIST }}.summary.csv" || true
          echo ""
          echo "Skipped:"
          head -n 10 "${{ env.STALE_FILE_LIST }}.skipped.csv" || true

      - name: Run DocuMentor passes (placeholder)
        shell: bash
        run: |
          if [ ! -s "${{ env.STALE_FILE_LIST }}" ]; then
            echo "No files selected; skipping DocuMentor."
            exit 0
          fi
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            echo "→ DocuMentor on $f"
            # Replace with your real CLI commands:
            # ./documentor fix --file "$f" --rules "learn-markdown,frontmatter"
            # ./documentor optimize --file "$f" --prompts "seo,geo"
          done < "${{ env.STALE_FILE_LIST }}"

      # ───────── meta: unique branch label ─────────
      - name: Meta (unique labels)
        id: meta
        shell: bash
        run: |
          echo "date=$(date -u +'%Y%m%d')" >> "$GITHUB_OUTPUT"
          echo "run=${GITHUB_RUN_ID}"       >> "$GITHUB_OUTPUT"
          echo "sha=${GITHUB_SHA::7}"       >> "$GITHUB_OUTPUT"

      # detect whether we actually changed files
      - name: Detect changes
        id: detect
        shell: bash
        run: |
          if git status --porcelain | grep -q .; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # commit locally (base new branch on upstream target)
      - name: Commit locally
        if: ${{ steps.detect.outputs.changed == 'true' }}
        id: commit
        shell: bash
        run: |
          set -e
          git config user.name  "docs-automation"
          git config user.email "docs-automation@users.noreply.github.com"
          BRANCH="${WORKING_BRANCH_PREFIX}/${{ steps.meta.outputs.date }}-run${{ steps.meta.outputs.run }}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH" "origin/${TARGET_BRANCH}"
          git add -A
          git commit -m "Freshness automation (runtime ms.date check + DocuMentor placeholders)"

      # push to your fork (fast-forward only; auto-rename if collision)
      - name: Push branch to fork (JulCsc/powerbi-docs-pr)
        if: ${{ steps.detect.outputs.changed == 'true' }}
        id: pushfork
        env:
          FORK_PR_TOKEN: ${{ secrets.FORK_PR_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          FORK_OWNER="JulCsc"
          FORK_REPO="powerbi-docs-pr"
          BRANCH="${{ steps.commit.outputs.branch }}"
          FORK_URL="https://x-access-token:${FORK_PR_TOKEN}@github.com/${FORK_OWNER}/${FORK_REPO}.git"

          # Remove checkout's auth header so PAT takes effect
          git config --global http.https://github.com/.extraheader ""

          # Add or update 'fork' remote
          if git remote | grep -q "^fork$"; then
            git remote set-url fork "${FORK_URL}"
          else
            git remote add fork "${FORK_URL}"
          fi

          # Sanity: verify token can read the fork
          git ls-remote --heads fork >/dev/null

          # Try to create the branch in fork (no force)
          set +e
          git push -u fork "${BRANCH}:${BRANCH}"
          RC=$?
          set -e

          if [ $RC -ne 0 ]; then
            echo "Initial push failed (likely existing branch). Using unique suffix…"
            ALT="${BRANCH}-${{ steps.meta.outputs.sha }}"
            git push -u fork "${BRANCH}:${ALT}"
            echo "branch=${ALT}" >> $GITHUB_OUTPUT
          else
            echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          fi

      # install jq for JSON body
      - name: Install jq (for JSON body)
        if: ${{ steps.detect.outputs.changed == 'true' }}
        run: sudo apt-get update && sudo apt-get install -y jq

      # open PR from fork → upstream (using GitHub REST; no third-party actions)
      - name: Open PR from fork → upstream (GitHub REST)
        if: ${{ steps.detect.outputs.changed == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          UPSTREAM_OWNER="${{ github.repository_owner }}"
          UPSTREAM_REPO="${{ github.event.repository.name }}"
          HEAD="JulCsc:${{ steps.pushfork.outputs.branch }}"
          BASE="${{ env.TARGET_BRANCH }}"
          TITLE="Freshness: automated pass (forked PR) – ${{ steps.meta.outputs.date }}"

          BODY=$'This PR was generated by the freshness workflow.\n\n'\
          $'**What happened**\n'\
          $'- Built a batch from the engagement export/report\n'\
          $'- Re-checked each file’s current ms.date; skipped those already fresh\n'\
          $'- Ran DocuMentor passes (if configured)\n\n'\
          $'**Run artifacts**\n'\
          $'- Processed: `tools/stale-files.txt`\n'\
          $'- Summary:   `tools/stale-files.summary.csv`\n'\
          $'- Skipped:   `tools/stale-files.skipped.csv`\n'

              RESP=$(curl -sS -X POST \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${UPSTREAM_OWNER}/${UPSTREAM_REPO}/pulls" \
                -d "$(jq -n --arg t "$TITLE" --arg h "$HEAD" --arg b "$BASE" --arg body "$BODY" '{title:$t, head:$h, base:$b, body:$body}')")

              echo "$RESP" | jq -r '.html_url // .message'
